@page "/ordens-servico"
@rendermode InteractiveServer
@using OsService.Web.ApiClients
@using OsService.Web.Components.Modals
@inject ServiceOrdersApiClient ServiceOrdersApi
@inject CustomersApiClient CustomersApi
@inject IJSRuntime JS

<PageTitle>Ordens de Serviço</PageTitle>

<div class="page-header fade-in">
    <h1><i class="bi bi-clipboard-check-fill"></i> Ordens de Serviço</h1>
    <p>Acompanhamento e controle das ordens de serviço</p>
</div>

<div class="action-buttons fade-in mb-3">
    <button class="btn btn-primary btn-custom" 
            type="button" 
            @onclick="AbrirModal">
        <i class="bi bi-plus-circle me-2"></i>
        Nova Ordem
    </button>

    <button class="btn btn-outline-secondary btn-custom" @onclick="RefreshAsync">
        <i class="bi bi-arrow-clockwise me-2"></i>
        Atualizar
    </button>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        @errorMessage
    </div>
}

@if (ordens is null)
{
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <p class="mt-3">Carregando...</p>
    </div>
}
else if (!ordens.Any())
{
    <div class="empty-state">
        <i class="bi bi-clipboard-x"></i>
        <h3>Nenhuma ordem cadastrada</h3>
    </div>
}
else
{
    <div class="search-box fade-in">
        <i class="bi bi-search"></i>
        <input class="form-control" placeholder="Buscar..." @bind="searchTerm" @bind:event="oninput" />
    </div>

    <div class="custom-table fade-in" style="overflow: visible;">
        <table class="table">
            <thead>
                <tr>
                    <th>Número</th>
                    <th>Cliente</th>
                    <th>Descrição</th>
                    <th>Status</th>
                    <th>Abertura</th>
                    <th>Preço</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ordem in OrdensFiltradas)
                {
                    var status = ObterStatusInfo(ordem.Status);
                    <tr>
                        <td><span class="badge bg-primary">#@ordem.Number</span></td>
                        <td><strong>@ordem.CustomerName</strong></td>
                        <td>@ordem.Description</td>
                        <td>
                            <span class="status-badge @status.Class">
                                <i class="bi @status.Icon me-1"></i>
                                @status.Text
                            </span>
                        </td>
                        <td>@ordem.OpenedAt.ToShortDateString()</td>
                        <td>
                            @if (ordem.Price.HasValue)
                            {
                                <strong class="text-success">@ordem.Coin @ordem.Price.Value.ToString("N2")</strong>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <div class="dropdown" style="position: static;">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" 
                                        type="button" 
                                        id="dropdownMenu-@ordem.Id" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false">
                                    Ações
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenu-@ordem.Id">
                                    <li>
                                        <a class="dropdown-item" href="javascript:void(0)" @onclick="() => AbrirModalStatus(ordem)">
                                            <i class="bi bi-arrow-repeat me-2"></i>
                                            Atualizar Status
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="javascript:void(0)" @onclick="() => AbrirModalPreco(ordem)">
                                            <i class="bi bi-currency-dollar me-2"></i>
                                            Atualizar Preço
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- MODAL FORMULÁRIO -->
<div class="modal fade" id="modal-formulario-os" tabindex="-1" aria-labelledby="modalFormularioOSLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <EditForm Model="@formulario" OnValidSubmit="OnSalvar">
                <DataAnnotationsValidator />
                
                <div class="modal-header bg-primary text-white">
                    <h3 class="modal-title" id="modalFormularioOSLabel">
                        <i class="bi bi-clipboard-plus me-2"></i>
                        Ordem de Serviço
                    </h3>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label fw-bold">Cliente *</label>
                                <InputSelect class="form-select" @bind-Value="formulario.CustomerId">
                                    <option value="@Guid.Empty">Selecione um cliente</option>
                                    @if (clientes is not null)
                                    {
                                        @foreach (var cliente in clientes)
                                        {
                                            <option value="@cliente.Id">@cliente.Name</option>
                                        }
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => formulario.CustomerId)" class="text-danger" />
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Descrição *</label>
                                <InputTextArea class="form-control" @bind-Value="formulario.Description" 
                                               placeholder="Descreva o serviço..." 
                                               rows="4" 
                                               maxlength="500" />
                                <ValidationMessage For="@(() => formulario.Description)" class="text-danger" />
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(errorModal))
                        {
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                @errorModal
                            </div>
                        }
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <span>Salvar</span>
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<UpdateStatusModal @ref="modalStatus" AoAtualizar="ManipularAtualizacao" />
<UpdatePriceModal @ref="modalPreco" AoAtualizar="ManipularAtualizacao" />

@code {
private enum ServiceOrderStatus
{
    Open = 0,
    InProgress = 1,
    Finished = 2
}

private ServiceOrderDto[]? ordens;
private CustomerDto[]? clientes;
private string searchTerm = string.Empty;
private string? errorMessage;

private OpenServiceOrderRequest formulario = new() { CustomerId = Guid.Empty };
private bool isSubmitting = false;
private string? errorModal;

// Referências às modals
private UpdateStatusModal modalStatus = default!;
private UpdatePriceModal modalPreco = default!;

    private IEnumerable<ServiceOrderDto> OrdensFiltradas =>
        ordens is null || string.IsNullOrWhiteSpace(searchTerm)
            ? ordens ?? []
            : ordens.Where(o =>
                o.Number.ToString().Contains(searchTerm) ||
                o.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
            );

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(
            LoadOrdensAsync(),
            LoadClientesAsync()
        );
    }

    private async Task LoadOrdensAsync()
    {
        try
        {
            ordens = await ServiceOrdersApi.GetServiceOrdersAsync();
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro: {ex.Message}";
            ordens = [];
        }
    }

    private async Task LoadClientesAsync()
    {
        try
        {
            clientes = await CustomersApi.GetCustomersAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar clientes: {ex.Message}");
            clientes = [];
        }
    }

    private async Task RefreshAsync() => await LoadOrdensAsync();

    private async Task AbrirModal()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", @"
                var modal = new bootstrap.Modal(document.getElementById('modal-formulario-os'));
                modal.show();
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao abrir modal: {ex.Message}");
            errorMessage = $"Erro ao abrir modal: {ex.Message}";
        }
    }

    private async Task FecharModal()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", @"
                var modal = bootstrap.Modal.getInstance(document.getElementById('modal-formulario-os'));
                if (modal) modal.hide();
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao fechar modal: {ex.Message}");
        }
    }

    private async Task OnSalvar()
    {
        if (formulario.CustomerId == Guid.Empty)
        {
            errorModal = "Cliente é obrigatório.";
            return;
        }

        if (string.IsNullOrWhiteSpace(formulario.Description))
        {
            errorModal = "Descrição é obrigatória.";
            return;
        }

        isSubmitting = true;
        errorModal = null;

        try
        {
            await ServiceOrdersApi.OpenServiceOrderAsync(formulario);
            
            formulario = new() { CustomerId = Guid.Empty };
            await LoadOrdensAsync();
            
            await FecharModal();
        }
        catch (Exception ex)
        {
            errorModal = $"Erro: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task AbrirModalStatus(ServiceOrderDto ordem)
    {
        await modalStatus.Abrir(ordem);
    }

    private async Task AbrirModalPreco(ServiceOrderDto ordem)
    {
        await modalPreco.Abrir(ordem);
    }

    private async Task ManipularAtualizacao()
    {
        await LoadOrdensAsync();
    }

    private (string Text, string Class, string Icon) ObterStatusInfo(int status) =>
        (ServiceOrderStatus)status switch
        {
            ServiceOrderStatus.Open => ("Aberta", "open", "bi-circle-fill"),
            ServiceOrderStatus.InProgress => ("Em Andamento", "in-progress", "bi-hourglass-split"),
            ServiceOrderStatus.Finished => ("Finalizada", "finished", "bi-check-circle-fill"),
            _ => ("Desconhecido", "open", "bi-question-circle")
        };
}

